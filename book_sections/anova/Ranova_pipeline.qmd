## •  19. R ANOVA pipeline  {.unnumbered  #Ranova_pipeline}

```{r}
#| echo: false
#| message: false
#| warning: false
library(knitr)
library(dplyr)
library(readr)
library(stringr)
library(janitor)
library(ggforce)
library(webexercises)
library(ggplot2)
library(tidyr)
library(broom)
library(forcats)
source("../../_common.R") 

hz_link <- "https://raw.githubusercontent.com/ybrandvain/datasets/refs/heads/master/zones_df_admix_weight_cutoff0.9_gps_dist2het_phenos_excl_GC.csv"

clarkia_hz <- read_csv(hz_link)|> 
  select(-weighted)|>
  rename(admix_proportion = `cutoff0.9`) |>
  filter(!is.na(admix_proportion))|>
  clean_names() |>
  mutate(site = if_else(site == "SAW", "SR", site)) |>
  filter(subsp=="P")|>
  mutate(site = fct_reorder(site, mean_petal_area_sq_cm))
```

---

Here's a brief review of how to complete all the bits of an ANOVA in `R`. To do so, we will look into `Sepal.Width` by `Species` in the `iris` dataset.  

:::aside
Brought to you by popular demand!
:::

## ANOVA calculations by hand

We can  decompose variance components ourselves as follows:

**First as the sums of squares**

```{r}
SS_iris <- iris |>
  mutate(grand_mean = mean(Sepal.Width))|>
  group_by(Species)|>
  mutate(group_mean = mean(Sepal.Width))|>
  ungroup()|>
  summarise(SS_model = sum((group_mean   - grand_mean)^2) , 
            SS_error = sum((Sepal.Width - group_mean)^2) , 
            SS_total = sum((Sepal.Width - grand_mean)^2),
            n_total  = n(),
            n_groups = n_distinct(Species))
```

```{r}
#| echo: false
SS_iris |> mutate_at(1:3, round , digits = 3)|>kable()
```


---

**Then as full blown ANOVA results**

```{r}
anova_results <- SS_iris |>
  mutate(df_model = n_groups - 1,
         df_error  = n_total  - n_groups,
         MS_model  = SS_model / df_model,
         MS_error  = SS_error / df_error,
         F_stat    = MS_model / MS_error,
         r2        = SS_model / SS_total,
         p_value   = pf(F_stat , df1 = df_model, df2 = df_error, 
                        lower.tail = FALSE)) 
```


```{r}
#| echo: false
#| column: page-right
anova_results |> mutate_at(c(1:3, 8:11), round , digits =2)|> select(-p_value,-n_groups,-n_total)|>mutate(p_value = "4.49e-17")|>kable()
```



## Or R can do this for you

We saw we can do this with the `aov() |> summary()` pipeline, or the `lm() |> anova()` pipeline. Here I do the latter.  Either way our answers matvh those that we derived above:

```{r}
lm(Sepal.Width ~ Species, data = iris) |> 
  anova()
```

The `tidy()` function in the `broom` package makes this output tidy and shows our p-values are identical!

```{r}
library(broom)
lm(Sepal.Width ~ Species, data = iris) |> 
  anova()|>
  tidy()
```

### Posthoc tests and significance groups

As above there are a few ways to do this, and, as above we stuck the the `lm()` framework.

```{r}
library(multcomp)
lm(Sepal.Width ~ Species, data = iris)|>
   glht(linfct = mcp(Species = "Tukey"))|> 
   summary()
```

We see that all groups differ significantly from one another. So call one significance group "a", another significance group "b", and the third significance group "c". It doesn’t matter which one’s which—just that they’re all different. These are arbitrary labels. For more complex cases, R can find significance groups for us:





```{r}
lm(Sepal.Width ~ Species, data = iris)|>
   glht(linfct = mcp(Species = "Tukey"))|> 
   cld()
```